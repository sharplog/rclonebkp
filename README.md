# rclonebkp
a backup tool implemented with rclone

## 适应场景：
生产环境下的文件都是新产生（或修改）的，不会出现修改时间是以前的文件。原因有二：
1. 本工具使用文件的修改时间来区分不同备份的内容，认为在备份时间之前的文件在本次备份中一定会出现。如果有
   的文件是后来才有，但修改时间比已经备份的时间还早，会造成混乱；
2. 本工具的增量备份模式中，为提高效率，使用了 rclone 的 --max-age 选项，如果生产环境中有新添加的文件早
   于上次备份时间，则不会被备份，造成遗漏。
   
## 备份服务器：
凡是 rclone 可以作为目标服务器进行 copy 或 sync 的应该都是可以的。需要：
1. 在 rclone 配置文件中添加目标服务器的配置，或通过环境变量、命令行参数等自行设置，本工具不负责管理；
2. 目标服务器不要开启版本控制，本工具不使用服务器的版本控制功能。
 
## 备份模式：
本工具支持全量备份和增量备份两种模式。本工具中两种模式的含义如下：
1. 全量备份：使用 rclone sync 进行文件同步。所以每次备份 rclone 都会将源和目标端的文件都扫描一遍，把发生
   变化的文件给同步过去，包括删除的文件也会从目标端删除。如果文件很多的话，可能会比较耗时；
2. 增量备份：使用 rclone copy 进行文件复制。每次备份时，为 rclone 指定 --max-age 选项，只复制自上次备份
   以来发生变化的文件，文件即使在源端被删除，也会在目标端一直保留，直到通过本工具删除。
一个备份库（store_path）所使用的备份模式是固定的，在初始化（init）时指定，不能在备份过程中切换备份模式。

## 备份：
使用本工具的 backup 命令进行备份。本工具在备份时已经使用了 --progress、--verbose，用户也可以添加 rclone 
支持的其他选项，但以下选项不要用：
  --backup-dir 本工具需要用来维护各备份快照的内容，不能由用户指定；
  --max-age    在增量备份模式下，本工具会自动设置该选项，不能由用户指定。用户也要慎用--min-age，以免造成
               不可预期的后果；

## store_path：
本工具使用 store_path 来表示一个备份库，一个 store_path 对应一个备份库。store_path 是一个目录，本工具会
在该目录下维护备份快照的内容。初始化时作为备份库的 store_path 必须是一个空目录，不能包含任何文件或子目录。

## 使用本工具的过程：
1. 初始化备份库：使用 init 命令初始化备份库，指定备份库的路径（store_path）和备份模式（incremental
   或 full），并可以配置备份时的常用选项；
2. 备份：使用本工具的 backup 命令进行备份；
3. 列出备份快照：使用 snapshots 命令列出备份库中所有的备份快照；
4. 查看快照内容：使用 list 命令查看指定备份快照中某一路径下的内容；
5. 删除备份快照：使用 remove 命令删除备份库中的备份快照；
6. 按策略删除快照：使用 forget 命令按策略删除备份库中的备份快照；
7. 删除旧数据：使用 rm_before 命令删除备份库中超过指定时间的数据；
8. 删除备份库：使用 delete 命令删除备份库；

## 本工具使用的 rclone 命令：
本工具使用了如下 rclone 命令：
copy、copyto、delete、lsf、lsjson、mkdir、move、purge、rmdirs、size、sync等
